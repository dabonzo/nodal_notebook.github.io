
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://NodalNotebook.aria-network.com/technical_advice/auto-adjusting-screen-resolutions-kvm-qemu-udev-spice/">
      
      
        <link rel="prev" href="../../cybersecurity_arsenal/">
      
      
        <link rel="next" href="../../resources/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.3.1">
    
    
      
        <title>Auto-Adjusting Screen Resolutions in Virtual Machines - Nodal Notebook</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.046329b4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.85d0ee34.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#auto-adjusting-screen-resolutions-in-virtual-machines-the-power-of-udev-and-spice" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Nodal Notebook" class="md-header__button md-logo" aria-label="Nodal Notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Nodal Notebook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Auto-Adjusting Screen Resolutions in Virtual Machines
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../ctf_walkthroughs/" class="md-tabs__link">
        
  
    
  
  CTF Walkthrougs

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../sysadmin_chronicles/" class="md-tabs__link">
        
  
    
  
  Sysadmin Chronicles

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../cybersecurity_arsenal/" class="md-tabs__link">
        
  
    
  
  Cybersecurity Arsenal

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  Technical Advice

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../resources/" class="md-tabs__link">
        
  
    
  
  Resources

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about_me/" class="md-tabs__link">
        
  
    
  
  About Me

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Nodal Notebook" class="md-nav__button md-logo" aria-label="Nodal Notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Nodal Notebook
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../ctf_walkthroughs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF Walkthrougs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../sysadmin_chronicles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sysadmin Chronicles
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../cybersecurity_arsenal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cybersecurity Arsenal
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Technical Advice
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Technical Advice
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" checked>
        
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Virtualization
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Virtualization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Auto-Adjusting Screen Resolutions in Virtual Machines
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Auto-Adjusting Screen Resolutions in Virtual Machines
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-problem" class="md-nav__link">
    The Problem
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-solution" class="md-nav__link">
    The Solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-the-components" class="md-nav__link">
    Understanding the Components
  </a>
  
    <nav class="md-nav" aria-label="Understanding the Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spice" class="md-nav__link">
    SPICE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spice-agent" class="md-nav__link">
    spice-agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udev" class="md-nav__link">
    udev
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udev-rules" class="md-nav__link">
    udev rules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-the-spice-agent" class="md-nav__link">
    About the SPICE Agent
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-up" class="md-nav__link">
    Wrap-Up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credits" class="md-nav__link">
    Credits
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resources
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../../about_me/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About Me
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-problem" class="md-nav__link">
    The Problem
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-solution" class="md-nav__link">
    The Solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-the-components" class="md-nav__link">
    Understanding the Components
  </a>
  
    <nav class="md-nav" aria-label="Understanding the Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spice" class="md-nav__link">
    SPICE
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spice-agent" class="md-nav__link">
    spice-agent
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udev" class="md-nav__link">
    udev
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#udev-rules" class="md-nav__link">
    udev rules
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#about-the-spice-agent" class="md-nav__link">
    About the SPICE Agent
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrap-up" class="md-nav__link">
    Wrap-Up
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credits" class="md-nav__link">
    Credits
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="auto-adjusting-screen-resolutions-in-virtual-machines-the-power-of-udev-and-spice">Auto-Adjusting Screen Resolutions in Virtual Machines: The Power of udev and SPICE</h1>
<p>Have you ever been troubled by the non-responsive display resolution when working with virtual machines? If so, this article is tailor-made for you.</p>
<h2 id="the-problem">The Problem</h2>
<p>Using virtual machines, particularly with QEMU/KVM and <code>virt-manager</code>, I consistently encountered a snag: the screen resolution wouldn't automatically adjust to match the window size. This became particularly evident after upgrading a pre-built QEMU Virtual Machine. Everything worked perfectly at first, but the display resize feature stopped functioning later on, a problem I similarly noted with the netinstaller ISO.</p>
<p>Digging into this, I found the issue to be more prevalent with the XFCE desktop environment. Curiously, KDE and GNOME appeared unaffected, hinting at an underlying concern with XFCE. Considering the dated software on the pre-built VM, it's likely that updates or changes implemented between its initial release and subsequent upgrades introduced this issue.</p>
<p>Importantly, while my experience was with Kali Linux, this challenge is not exclusive to it; it's evident across multiple distributions. The silver lining? Utilizing <code>udev</code> rules can offer a comprehensive remedy for all Linux guest OSes that integrate <code>udev</code>.</p>
<h2 id="the-solution">The Solution</h2>
<p>Without further ado, here is the rule and the script that tackles the issue:</p>
<p>File: <code>/etc/udev/rules.d/50-resize.rules</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;change&quot;</span>,<span class="w"> </span><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;card0&quot;</span>,<span class="w"> </span><span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;drm&quot;</span>,<span class="w"> </span><span class="nv">RUN</span><span class="o">+=</span><span class="s2">&quot;/usr/local/bin/resize&quot;</span>
</code></pre></div></td></tr></table></div>
<details class="note">
<summary>Explaining the <code>udev</code> rule</summary>
<p>This rule listens for any changes (<code>ACTION=="change"</code>) on the primary graphics card (<code>KERNEL=="card0"</code>) under the <code>drm</code> (Direct Rendering Manager) subsystem. The <code>drm</code> subsystem is responsible for interfacing with GPUs in Linux and handles tasks like rendering graphics and adjusting screen resolutions.</p>
<p>Whenever a change is detected, it triggers (<code>RUN+</code>) our script (<code>/usr/local/bin/resize</code>), which will then adjust the screen resolution of the virtual machine.</p>
</details>
<p>File: <code>/usr/local/bin/resize</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nb">declare</span><span class="w"> </span>-A<span class="w"> </span>unique_users<span class="w"> </span>display_to_user_mapping

<span class="c1"># Identify unique users (excluding root)</span>
<span class="k">for</span><span class="w"> </span>current_user<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>users<span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="o">[[</span><span class="w"> </span><span class="nv">$current_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>root<span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">continue</span>
<span class="w">    </span>unique_users<span class="o">[</span><span class="nv">$current_user</span><span class="o">]=</span><span class="m">1</span>
<span class="k">done</span>

<span class="c1"># Map displays to users</span>
<span class="k">for</span><span class="w"> </span>user<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">!unique_users[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span>display_info<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>ps<span class="w"> </span>e<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$user</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-o<span class="w"> </span><span class="s1">&#39;DISPLAY=:[0-9]*&#39;</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="nv">display_number</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">display_info</span><span class="p">#*=</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">        </span>display_to_user_mapping<span class="o">[</span><span class="nv">$display_number</span><span class="o">]=</span><span class="nv">$user</span>
<span class="w">    </span><span class="k">done</span>
<span class="k">done</span>

<span class="c1"># Adjust resolution for each user&#39;s display</span>
<span class="k">for</span><span class="w"> </span>display<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="p">!display_to_user_mapping[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="nv">associated_user</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">display_to_user_mapping</span><span class="p">[</span><span class="nv">$display</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">user_display</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$display</span><span class="s2">&quot;</span>
<span class="w">    </span><span class="nv">output_device</span><span class="o">=</span><span class="k">$(</span>sudo<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$associated_user</span><span class="s2">&quot;</span><span class="w"> </span><span class="nv">DISPLAY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$user_display</span><span class="s2">&quot;</span><span class="w"> </span>xrandr<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;/ connected/{print $1; exit;}&#39;</span><span class="k">)</span>
<span class="w">    </span>sudo<span class="w"> </span>-u<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$associated_user</span><span class="s2">&quot;</span><span class="w"> </span><span class="nv">DISPLAY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$user_display</span><span class="s2">&quot;</span><span class="w"> </span>xrandr<span class="w"> </span>--output<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output_device</span><span class="s2">&quot;</span><span class="w"> </span>--auto
<span class="k">done</span>
</code></pre></div></td></tr></table></div>
<p>Dive deeper if you're curious about how the code functions:</p>
<details class="note">
<summary>How the script works</summary>
<p><strong>Explanation</strong>:</p>
<ul>
<li>
<p><strong>User Identification</strong>: The script begins by identifying all the users currently logged in, making a list of unique users. Notably, the <code>root</code> user is excluded. This is because in Linux environments, the <code>root</code> user typically does not run graphical sessions; it's generally considered insecure to do so. Hence, there's no screen to resize for the <code>root</code> user.</p>
</li>
<li>
<p><strong>Display Mapping</strong>: Once the users are identified, the script maps the display environment variable (<code>DISPLAY</code>) to each user. This is crucial because in Linux, graphical sessions are linked with a <code>DISPLAY</code> value, which essentially indicates which screen or monitor the graphical output is being sent to.</p>
</li>
<li>
<p><strong>Resolution Adjustment</strong>: With the user-to-display map in hand, the script then cycles through each display, determines its output device (like HDMI-1 or eDP-1) using the <code>xrandr</code> tool, and finally resizes the display to fit automatically using the <code>--auto</code> flag.</p>
</li>
</ul>
<p><strong>In a Nutshell</strong>: The script automates what can be a manual and cumbersome process: ensuring your virtual machine's display dynamically adjusts to your window size, providing an uninterrupted user experience. By excluding <code>root</code>, it also ensures the security principle of minimizing potential attack surfaces is maintained.
By pairing the above script with the simple udev rule, we can automatically adjust the display resolution whenever there's a change in the VM window size. Now, let's dive deeper.</p>
</details>
<h2 id="understanding-the-components">Understanding the Components</h2>
<h3 id="spice">SPICE</h3>
<p>Simple Protocol for Independent Computing Environments (SPICE) is a remote display system primarily for virtualized environments. It improves the user experience by integrating audio, video, and several other features, offering a rich virtual machine console access experience.</p>
<h3 id="spice-agent">spice-agent</h3>
<p>spice-agent is a guest agent that provides several facilities to improve the interaction between the host and guest VM, including clipboards syncing, automatic screen resolution adjustments, and more.</p>
<h3 id="udev">udev</h3>
<p>udev is a device manager for the Linux kernel. It dynamically manages device nodes in the /dev directory and offers userspace events whenever the status of hardware (like adding/removing devices) changes.</p>
<details class="note">
<summary>More about <code>udev</code></summary>
<p><code>udev</code> is widely used in the Linux ecosystem. It has become the de facto standard for device detection and management in modern Linux distributions. Here's why it's prevalent:</p>
<ol>
<li>
<p><strong>Unified Device Management:</strong> Before <code>udev</code>, device node handling in the <code>/dev</code> directory was static. As Linux systems became more dynamic, especially with the proliferation of USB devices and other hot-pluggable hardware, a more flexible system was required. <code>udev</code> fills this need by providing dynamic device node creation and management.</p>
</li>
<li>
<p><strong>Part of <code>systemd</code>:</strong> In many modern Linux distributions, <code>udev</code> functionality has been merged into <code>systemd</code> as <code>systemd-udevd</code>. <code>systemd</code> itself is a widely adopted init system and service manager for Linux. This integration further solidified <code>udev</code>'s position in the Linux ecosystem.</p>
</li>
<li>
<p><strong>Configurability:</strong> <code>udev</code> allows administrators and developers to write rules specific to their needs. This level of customizability is beneficial for various applications, ranging from desktops to servers to embedded systems.</p>
</li>
<li>
<p><strong>Consistent Device Naming:</strong> <code>udev</code> provides persistent device naming, ensuring that devices get consistent names across reboots. This feature is essential for administrators and users, ensuring, for example, that storage devices always get mounted at the expected locations.</p>
</li>
<li>
<p><strong>Hotplug Support:</strong> Modern computers frequently have devices added or removed while the system is running (think USB devices, SD cards, etc.). <code>udev</code> supports such hotplug scenarios, ensuring the system reacts appropriately when devices are plugged or unplugged.</p>
</li>
<li>
<p><strong>Compatibility:</strong> While <code>udev</code> provides advanced features and configurability, it's designed to be backward compatible. This means even systems or setups that depended on the older, static <code>/dev</code> approach can still function under <code>udev</code>.</p>
</li>
</ol>
<p>Given its importance and the functionalities it offers, <code>udev</code> is a critical component in nearly all major Linux distributions today. Whether you're on a desktop Linux distribution like Ubuntu, Fedora, or Debian, or server distributions like CentOS or RHEL, or even embedded systems, <code>udev</code> (or its functionalities as part of <code>systemd-udevd</code>) plays a vital role in device management.</p>
</details>
<h3 id="udev-rules">udev rules</h3>
<p>These are configurations that dictate how udev responds to specific hardware changes. In our context, we utilize udev rules to trigger our screen resolution adjustment script when there's a change in the display settings of the VM.</p>
<h2 id="about-the-spice-agent">About the <code>SPICE Agent</code></h2>
<p>For the auto-resize feature to work with QEMU/KVM when using the SPICE protocol, you typically need the <code>spice-vdagent</code> (often referred to as the "SPICE agent") running inside the guest. The SPICE agent facilitates many enhanced functionalities, including clipboard sharing, automatic screen resizing, and more.</p>
<p>Here's how it all comes together:</p>
<ol>
<li>
<p><strong>Guest Display Resizing:</strong> When you resize the QEMU/KVM guest window on the host, the SPICE client (like <code>virt-viewer</code> or <code>spicy</code>) sends a message to the SPICE server component running with QEMU, indicating the new screen dimensions.</p>
</li>
<li>
<p><strong>SPICE Server to Guest:</strong> The SPICE server then communicates this information to the <code>spice-vdagent</code> running inside the guest. This is achieved using a virtual channel.</p>
</li>
<li>
<p><strong>Notification to the System:</strong> Once the <code>spice-vdagent</code> in the guest receives the resize information, it triggers a change event in the graphics subsystem. This event is detected by the udev subsystem thanks to the rule you set up, which then launches the <code>/usr/local/bin/resize</code> script to adjust the screen resolution accordingly.</p>
</li>
</ol>
<p>To ensure the SPICE agent is operational:</p>
<ol>
<li>
<p><strong>Installation:</strong> Ensure <code>spice-vdagent</code> is installed in the guest.
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>spice-vdagent
</code></pre></div></td></tr></table></div></p>
</li>
<li>
<p><strong>Autostart:</strong> Ensure the <code>spice-vdagent</code> service is enabled to start automatically on boot. Depending on the init system, this might involve using <code>systemctl</code> or another service manager.</p>
</li>
<li>
<p><strong>Manual Start:</strong> You can also manually start the agent from within the guest, usually by just running <code>spice-vdagent</code> from the terminal.</p>
</li>
</ol>
<p>If the SPICE agent isn't running, the screen resize event from the SPICE client won't be propagated to the guest system, and as a result, the udev rule won't be triggered.</p>
<h2 id="wrap-up">Wrap-Up</h2>
<p>Harnessing the capabilities of <code>udev</code>, <code>shell scripting</code>, <code>SPICE</code>, and <code>spice-agent</code>, we've fashioned a solution to tackle the irksome issue of non-responsive VM screen resolutions. No more manual tinkering — just seamless auto-adjustments.</p>
<h2 id="credits">Credits</h2>
<p>The insights and techniques mentioned in this article have been sourced from a few excellent discussions and solutions from the community:</p>
<ul>
<li>
<p><strong>Finding Sessions as Root</strong>: <a href="https://unix.stackexchange.com/questions/117083/how-to-get-the-list-of-all-active-x-sessions-and-owners-of-them">How to get the list of all active X sessions and owners of them?</a> on Unix Stack Exchange.</p>
</li>
<li>
<p><strong>Resizing via udev</strong>:</p>
<ul>
<li><a href="https://superuser.com/questions/1183834/no-auto-resize-with-spice-and-virt-manager">No auto resize with SPICE and virt-manager</a> on Super User.</li>
<li><a href="https://dannyda.com/2020/10/22/how-to-fix-cant-resize-kali-linux-vm-screen-display-via-virt-viewer-running-on-proxmox-ve-pve-with-default-xfce4-desktop-environment/#1-Via-Command-directly-(Resize-Manually)">How to fix can't resize Kali Linux VM screen display via Virt Viewer running on Proxmox VE (PVE) with default XFCE4 desktop environment?</a> by Dannyda.com.</li>
</ul>
</li>
</ul>
<p>Got thoughts, or better ways to handle this? Let's discuss below or connect on <a href="https://www.linkedin.com/in/dani-speh-7221b9220/">LinkedIn</a>!</p>
<blockquote>
<p><strong>Note</strong>: When deploying the script, ensure to accompany it with the required udev rule, grant the script execute permissions, and have <code>spice-agent</code> running in your VM.</p>
</blockquote>
<p>Happy virtualizing! 🖥️🔄🖼️</p>





  <h2 id="__comments">Comments</h2>
I value your feedback and ideas! This site was developed with mkdocs and the material plugin. If you're inclined to contribute, feel free to submit a pull request. Check out the repository at <a href="https://github.com/dabonzo/nodal_notebook">https://github.com/dabonzo/nodal_notebook</a>.
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
        data-repo="dabonzo/nodal_notebook"
        data-repo-id="R_kgDOKXd1qQ"
        data-category="General"
        data-category-id="DIC_kwDOKXd1qc4CZlaQ"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    // Set palette on initial load
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate"
        ? "transparent_dark"
        : "light"

      // Instruct Giscus to set theme
      giscus.setAttribute("data-theme", theme)
    }

    // Register event handlers after documented loaded
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate"
            ? "transparent_dark"
            : "light"

          // Instruct Giscus to change theme
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "search.suggest", "navigation.sections", "navigation.top", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>